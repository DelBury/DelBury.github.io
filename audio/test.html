<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    canvas {
      margin: 50px;
      display: block;
      border: 1px solid skyblue;
    }
  </style>
</head>

<body>
  <audio id="audio" src="../../resource/notes/c3.mp3"></audio>
  <button id="play">play</button>
  <button id="play-audio">audio</button>
  <button id="stop">stop</button>
  <canvas id="canvas" width="800" height="360"></canvas>
  <script>
    const handleClick = () => {
      const actx = new AudioContext()
      const osc = actx.createOscillator()
      osc.frequency.value = 261
      const gain = actx.createGain()
      const real = new Float32Array(5)
      const imag = new Float32Array(5)
      // for(let i in real) {
      //   real[i] = 0
      // }

      real[0] = 0
      real[1] = 10
      real[2] = 8
      real[3] = 7
      real[4] = 5

      imag[0] = 0
      imag[1] = 10
      imag[2] = 8
      imag[3] = 7
      imag[4] = 5
      const wave = actx.createPeriodicWave(real, imag)
      osc.setPeriodicWave(wave)

      osc.connect(gain)
      gain.connect(actx.destination)

      osc.start()
      gain.gain.linearRampToValueAtTime(1, actx.currentTime + 0.01)
      gain.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + 1)
      osc.stop(1)
    }
    document.getElementById('play').onclick = handleClick


    const audio = document.getElementById('audio')
    const actx = new AudioContext()
    // const source = actx.createMediaElementSource(audio)
    let source = actx.createOscillator()
    source.frequency.value = 261
    const real = new Float32Array(5)
    const imag = new Float32Array(5)
    for (let i in real) {
      real[i] = 0
    }

    // real[0] = 0
    // real[1] = 10
    // real[2] = 8
    // real[3] = 7
    // real[4] = 5

    imag[0] = 0
    imag[1] = 1
    imag[2] = 0
    imag[3] = 0
    imag[4] = 0.5
    const wave = actx.createPeriodicWave(real, imag)
    source.setPeriodicWave(wave)


    const gain = actx.createGain()
    gain.gain.value = 0.5
    const analyser = actx.createAnalyser()
    const maxDB = 0
    const minDB = -100
    // analyser.smoothingTimeConstant = 0.7
    // analyser.minDecibels = -120
    analyser.maxDecibels = 0
    const bufferLen = analyser.frequencyBinCount
    let buffer = new Uint8Array(bufferLen)
    source.connect(gain).connect(analyser).connect(actx.destination)

    let running = false
    audio.onended = () => running = false

    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    ctx.strokeStyle = '#333'
    const {
      width,
      height
    } = canvas
    const dx = (width - 20) / bufferLen * 2
    const dy = height / 256
    let x = 20
    const arr = []

    const fnLine = (n) => {
      const ddb = (maxDB - minDB) / n
      ctx.moveTo(20, height)
      ctx.lineTo(20, height - 20)
      for(let i = 0; i <= 10; i++) {
        ctx.setLineDash([3, 3, 6])
        ctx.save()
        ctx.strokeStyle = '#999'
        ctx.moveTo(25, i / n * height)
        ctx.lineTo(width, i / n * height)
        ctx.stroke()
        ctx.restore()
        ctx.setLineDash([])

        if(i === 0) {
          ctx.strokeText(Math.round(maxDB - ddb * i + ''), 2, i / n * height + 10)
        } else {
          ctx.strokeText(Math.round(maxDB - ddb * i + ''), 2, i / n * height)
        }
      }
    }
    const fn = () => requestAnimationFrame(() => {
      // analyser.getByteTimeDomainData(buffer)
      analyser.getByteFrequencyData(buffer)
      ctx.clearRect(0, 0, width, height)
      ctx.beginPath()
      fnLine(10)
      ctx.beginPath()
      let x = 20
      for (let i = 0; i < bufferLen; i++) {
        const y = height - buffer[i] * dy
        // const y = buffer[i] * dy
        if (i === 0) {
          ctx.moveTo(x, y)
        } else {
          arr.push(x, y)
          ctx.lineTo(x, y)
        }
        x += dx

        // if(y > 180) {
        //   console.log(x)
        // }
      }
      ctx.stroke()

      if (running) {
        fn()
      }
    })

    document.getElementById('play-audio').onclick = ev => {
      if (running) {
        return
      }
      running = true
      arr.length = 0
      ctx.clearRect(0, 0, width, height)
      x = 20
      ctx.beginPath()
      ctx.moveTo(x, height / 2)
      // audio.play()
      source.start()
      // gain.gain.linearRampToValueAtTime(1, actx.currentTime + 0.01)
      // gain.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + 1)

      source.stop(actx.currentTime + 1)
      source.onended = () => {
        source.disconnect()
        source = actx.createOscillator()
        source.frequency.value = 261
        source.setPeriodicWave(wave)
        source.connect(gain)
        running = false
      }
      fn()
    }

    document.getElementById('stop').onclick = () => {
      running = false
    }
    document.onkeydown = ev => {
      if (ev.keyCode === 32) {
        running = false
        ev.preventDefault()
      }
    }
  </script>
</body>

</html>