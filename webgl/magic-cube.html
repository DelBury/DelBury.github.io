<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic Cube</title>
  <link rel="stylesheet" href="./css/common.css">
  <style>
    :root {
      --exam-size: 120px;
    }
    .operation {
      margin-left: 2em;
    }
    .operation>*:not(:last-child),
    .third-operation>*:not(:last-child) {
      margin-bottom: 2em;
    }
    .btns {
      display: flex;
      flex-direction: column;
    }
    .btns>*:not(:last-child) {
      margin-bottom: 0.5em;
    }
    input[type="number"] {
      margin-left: 0.5em;
      width: 160px;
    }
    label {
      display: flex;
      align-items: center;
    }
    .btn-table {
      display: grid;
      grid-template-columns: 100px 100px;
      gap: 0.5em;
      user-select: none;
    }
    .boxes {
      display: flex;
    }
    .container-3d {
      perspective: 800px;
      perspective-origin: center;
      transform-style: preserve-3d;
    }
    .container-3d {
      padding-right: 25%;
    }
    .exam {
      position: relative;
      width: var(--exam-size);
      height: var(--exam-size);
      transform-style: preserve-3d;
      transform: rotate3d(-0.5, -1.4, 0.2, 45deg);
    }
    .exam>* {
      position: absolute;
      border: 1px solid #000;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      font-size: 16px;
    }
    .exam-f {
      background-color: rgb(0, 255, 0);
      /* transform: translateX(-50%) rotateY(-90deg); */
      /* transform-origin: right center; */
    }
    .exam-r {
      background-color: rgb(255, 128, 0);
      transform: translateX(100%) rotateY(90deg);
      transform-origin: left center;
    }
    .exam-u {
      background-color: rgb(255, 255, 0);
      transform: translateY(-100%) rotateX(90deg);
      transform-origin: center bottom;
    }
    .exam1 .exam-f,
    .exam1 .exam-r {
      display: flex;
      align-items: stretch;
    }
    .exam1 .col {
      position: relative;
      padding: 1em 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }
    .exam1 .col:not(:last-of-type) {
      border-right: 1px solid #000;
    }
    .exam1 .col::before {
      position: absolute;
      display: block;
      content: "↑";
      top: 0;
    }
    .exam1 .col::after {
      position: absolute;
      display: block;
      content: "↓";
      bottom: 0;
    }
    .exam2 .exam-f,
    .exam2 .exam-r {
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .exam2 .col {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .exam2 .col:not(:last-of-type) {
      border-bottom: 1px solid #000;
    }
    .exam2 .exam-f .col {
      padding-left: 1.4em;
    }
    .exam2 .exam-f .col::before {
      position: absolute;
      display: block;
      content: "←";
      left: 0.2em;
    }
    .exam2 .exam-r .col {
      padding-right: 1.8em;
      align-items: flex-end;
    }
    .exam2 .exam-r .col::after {
      position: absolute;
      display: block;
      content: "→";
      right: 0.4em;
    }
  </style>
</head>
<body>
  <div class="flex-full-center">
    <div class="relative">
      <canvas id="canvas" width="800" height="800"></canvas>
    </div>
    <div class="operation">
      <div class="third-operation">
        <!-- 图例 -->
        <!-- ↑↓←→ -->
        <div class="boxes">
          <div class="container-3d">
            <div class="exam exam1">
              <div class="exam-f">
                <!-- R, R' -->
              </div>
              <div class="exam-r">
                <!-- F, F' -->
              </div>
              <div class="exam-u">U</div>
            </div>
          </div>
          <div class="container-3d">
            <div class="exam exam2">
              <div class="exam-f">
                <!-- U -->
              </div>
              <div class="exam-r">
                <!-- U' -->
              </div>
              <div class="exam-u">U</div>
            </div>
          </div>
        </div>
        <div class="btn-table">
          <!-- F -->
        </div>
        <div class="btn-table">
          <!-- R -->
        </div>
        <div class="btn-table">
          <!-- U -->
        </div>
      </div>

      <div class="btns">
        <label for="order">魔方阶数
          <input id="order" type="number" min="2" max="6" step="1" value="3" placeholder="魔方阶数">
        </label>
        <label for="order">方块大小
          <input id="size" type="number" min="0.2" step="0.1" value="1" placeholder="方块大小">
        </label>
        <div>
          <button id="btn-order-confirm">重置</button>
          <button id="btn-random">随机</button>
          <button id="btn-recovery">还原</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import MagicCube from './js/MagicCube.js';
  
    const order = document.getElementById('order');
    const size = document.getElementById('size');

    const canvas = document.getElementById('canvas');
    const mc = new MagicCube(canvas, {}, +order.value);
    window.mc = mc;
    
    main();
    createOperationArea(mc.order);
    
    // 改变阶数
    document.getElementById('btn-order-confirm').onclick = ev => {
      const orderNum = parseInt(order.value)
      mc.changeOrder(orderNum, parseFloat(size.value));
      createOperationArea(orderNum);
    };

    // 旋转按钮
    const axisObj = { F: 2, R: 0, U: 1 };
    const commandFn = (text) => {
      const [face, index, reverse] = text;
      mc.rotatePlainCommand(axisObj[face], (+index - 1), !!reverse);
    };
    document.querySelectorAll('.btn-table>button').forEach(button => button.onclick = ev => commandFn(ev.target.innerText));

    // 随机化
    document.getElementById('btn-random').onclick = ev => {
      const count = Math.floor(Math.random() * 10 + 5);
      mc.randomRotatePlains(count);
    };

    // 还原
    document.getElementById('btn-recovery').onclick = ev => {
      mc.recoveryPlains();
    };

    // 创建右侧操作区
    function createOperationArea(order) {
      // 图例区
      const leftF = document.querySelector('.exam1 .exam-f');
      const leftR = document.querySelector('.exam1 .exam-r');
      const rightF = document.querySelector('.exam2 .exam-f');
      const rightR = document.querySelector('.exam2 .exam-r');

      let lft = '', lrt = '', rft = '', rrt = '';
      for(let i = 1; i <= order; i++) {
        lft += `<div class="col"><span>R${i}</span><span>R${i}'</span></div>`;
        lrt += `<div class="col"><span>F${i}'</span><span>F${i}</span></div>`;
        rft += `<div class="col"><span>U${i}</span></div>`;
        rrt += `<div class="col"><span>U${i}'</span></div>`;
      }
      leftF.innerHTML = lft;
      leftR.innerHTML = lrt;
      rightF.innerHTML = rft;
      rightR.innerHTML = rrt;

      // 图例区大小
      // const style = getComputedStyle(document.documentElement);
      const size = Math.max(120, order * 30);
      document.documentElement.style.setProperty('--exam-size', size + 'px');

      // 按钮区
      const btnTables = document.querySelectorAll('.btn-table');
      const btnMainKey = ['F', 'R', 'U'];
      btnTables.forEach((bt, btIndex) => {
        bt.innerHTML = '';
        for(let i = 1; i <= order; i++) {
          const btn1 = document.createElement('button');
          const btn2 = document.createElement('button');
          btn1.innerText = btnMainKey[btIndex] + i;
          btn2.innerText = btnMainKey[btIndex] + i + '\'';
          bt.append(btn1, btn2);
        }
      });
    }

    // 主函数
    function main() {
      let startRightPosition = null; // 记录鼠标右键开始点击的位置
      let startLeftPosition = null; // 记录鼠标左键开始点击的位置
      let prevLeftPosition = null; // 记录鼠标左键上一次的位置
      let rotating = false; // 是否处于旋转状态
      let selecting = false; // 选中状态中
      let selectOpen = false; // 旋转平面防抖

      // 鼠标按下事件
      canvas.onmousedown = ev => {
        if(![0, 2].includes(ev.button)) return;
        
        if(ev.button === 0 && !selecting) {
          // 左键
          if(mc.select(ev.offsetX, ev.offsetY)) {
            startLeftPosition = [ev.screenX, ev.screenY];
            prevLeftPosition = [ev.screenX, ev.screenY];
            selecting = true;
          }
        } else if(ev.button === 2 || !rotating) {
          // 右键
          startRightPosition = [ev.screenX, ev.screenY];
          rotating = true;
        }
      };
  
      // 鼠标抬起事件
      document.onmouseup = ev => {
        if(![0, 2].includes(ev.button)) return;
  
        if(ev.button === 0 && selecting) {
          // 左键
          mc.unselect();
          mc.rotatePlainEnd();
          selecting = false;
          selectOpen = false;
          startLeftPosition = null;
          prevLeftPosition = null;
        } else if(ev.button === 2 && rotating) {
          // 右键
          // mc.rotateEnd(); // 旋转结束
          mc.rotateBack(); // 旋转结束
          rotating = false;
          startRightPosition = null;
        }
      };
  
      // 鼠标移动事件
      document.onmousemove = ev => {
        if(!rotating && !selecting) return;

        if(rotating) {
          // 旋转
          const dx = ev.screenX - startRightPosition[0];
          const dy = ev.screenY - startRightPosition[1];
          const ratio = 0.3;
          mc.rotate(dx * ratio, dy * ratio);
        }
        if(selecting) {
          // 选中状态下
          if(!selectOpen) {
            const dx0 = ev.screenX - startLeftPosition[0];
            const dy0 = ev.screenY - startLeftPosition[1];
            if(Math.abs(Math.abs(dx0) - Math.abs(dy0)) > 5) {
              selectOpen = true;
            }
          }

          if(!selectOpen) return;
          const dx = ev.screenX - prevLeftPosition[0];
          const dy = ev.screenY - prevLeftPosition[1];
          const ratio = 0.3;
          mc.rotatePlain(dx * ratio, dy * -ratio);

          prevLeftPosition = [ev.screenX, ev.screenY];
        }
      };

      // 鼠标右键选择框
      canvas.oncontextmenu = ev => ev.preventDefault();
    }
  </script>
</body>
</html>